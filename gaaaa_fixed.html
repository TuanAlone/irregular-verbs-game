<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chronos: Trận Chiến Thời Gian — (Phiên bản sửa lỗi)</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Arial', sans-serif; }
        body { background: linear-gradient(135deg,#0f2027,#203a43,#2c5364); color: #fff; min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 20px; padding: 16px; background: rgba(0,0,0,0.28); border-radius: 10px; }
        h1 { color: #ffcc00; text-shadow: 0 0 10px rgba(255,204,0,0.35); }
        .game-area { display: flex; gap: 16px; flex-wrap: wrap; }
        .player-area { flex: 1 1 48%; background: rgba(0,0,0,0.2); border-radius: 10px; padding: 12px; min-height: 320px; }
        .player-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
        .timeline-points { font-size:1.5rem; font-weight:bold; color:#ff9900; }
        .energy { display:flex; align-items:center; gap:8px; }
        .energy-dots { display:flex; gap:6px; }
        .energy-dot { width:12px; height:12px; border-radius:50%; background:#444; opacity:0.4; }
        .energy-dot.active { background:#00ccff; box-shadow:0 0 6px #00ccff; opacity:1; }
        .zones { margin-bottom:8px; }
        .zone { margin-bottom:10px; padding:10px; background:rgba(0,0,0,0.1); border-radius:6px; }
        .zone-title { font-weight:bold; margin-bottom:8px; color:#ffcc00; }
        .cards-container { display:flex; gap:8px; flex-wrap:wrap; min-height:60px; }
        .card { width:90px; height:120px; border-radius:8px; padding:8px; display:flex; flex-direction:column; justify-content:space-between; cursor:pointer; transition:transform .15s; position:relative; box-shadow:0 2px 6px rgba(0,0,0,0.35); }
        .card:hover { transform:translateY(-6px); }
        .card-event { background:linear-gradient(135deg,#1a2a6c,#3a7bd5); }
        .card-manifestation { background:linear-gradient(135deg,#8e0e00,#c04848); }
        .card-fate { background:linear-gradient(135deg,#8e7800,#ffcc00); }
        .card-cost { position:absolute; top:6px; right:6px; background:rgba(0,0,0,0.5); width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; }
        .card-name { font-size:11px; text-align:center; font-weight:bold; margin-top:8px; }
        .card-desc { font-size:10px; text-align:center; margin-top:6px; }
        .hand { background:rgba(0,0,0,0.28); border-radius:10px; padding:12px; margin-top:12px; }
        .controls { display:flex; justify-content:center; gap:12px; margin-top:12px; }
        button { padding:10px 16px; border:none; border-radius:6px; background:#ffcc00; color:#000; font-weight:bold; cursor:pointer; transition:background .2s; }
        button:hover { background:#ffdd55; }
        button:disabled { background:#666; cursor:not-allowed; }
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.75); z-index:120; align-items:center; justify-content:center; }
        .modal-content { background:#2c5364; padding:18px; border-radius:10px; max-width:520px; width:90%; }
        .log { margin-top:12px; padding:12px; background:rgba(0,0,0,0.2); border-radius:8px; max-height:180px; overflow:auto; }
        .log-entry { margin-bottom:8px; font-size:13px; padding-bottom:6px; border-bottom:1px solid rgba(255,255,255,0.05); }
        .small { font-size:12px; color:#ddd; }
        @media (max-width:900px) { .player-area { flex:1 1 100%; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Chronos: Trận Chiến Thời Gian — (Phiên bản sửa lỗi & hoàn thiện)</h1>
            <p class="small">Đã sửa lỗi, modal hoạt động, nút rút bài / kết thúc lượt được gắn sự kiện. Người chơi 1 bắt đầu.</p>
        </header>

        <div class="game-area">
            <div class="player-area" id="player1-area">
                <div class="player-header">
                    <h2>Người chơi 1</h2>
                    <div style="display:flex;gap:12px;align-items:center;">
                        <div class="timeline-points" id="player1-timeline">20</div>
                        <div class="energy" id="player1-energy"><span class="small">Năng lượng:</span><div class="energy-dots" id="player1-energy-dots"></div></div>
                    </div>
                </div>

                <div class="zones">
                    <div class="zone">
                        <div class="zone-title">Dòng thời gian Tương lai</div>
                        <div class="cards-container" id="player1-future"></div>
                    </div>
                    <div class="zone">
                        <div class="zone-title">Hiện thân</div>
                        <div class="cards-container" id="player1-manifestations"></div>
                    </div>
                    <div class="zone">
                        <div class="zone-title">Nghĩa trang Quá khứ</div>
                        <div class="cards-container" id="player1-graveyard"></div>
                    </div>
                </div>
            </div>

            <div class="player-area" id="player2-area">
                <div class="player-header">
                    <h2>Người chơi 2</h2>
                    <div style="display:flex;gap:12px;align-items:center;">
                        <div class="timeline-points" id="player2-timeline">20</div>
                        <div class="energy" id="player2-energy"><span class="small">Năng lượng:</span><div class="energy-dots" id="player2-energy-dots"></div></div>
                    </div>
                </div>

                <div class="zones">
                    <div class="zone">
                        <div class="zone-title">Dòng thời gian Tương lai</div>
                        <div class="cards-container" id="player2-future"></div>
                    </div>
                    <div class="zone">
                        <div class="zone-title">Hiện thân</div>
                        <div class="cards-container" id="player2-manifestations"></div>
                    </div>
                    <div class="zone">
                        <div class="zone-title">Nghĩa trang Quá khứ</div>
                        <div class="cards-container" id="player2-graveyard"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="hand">
            <div class="zone-title">Bài trên tay</div>
            <div class="cards-container" id="hand-cards"></div>
        </div>

        <div class="controls">
            <button id="draw-btn">Rút 1 bài</button>
            <button id="end-turn-btn">Kết thúc lượt</button>
            <button id="recall-btn">Kích hoạt Hồi tưởng</button>
        </div>

        <div class="log" id="game-log">
            <div class="log-entry">Trò chơi bắt đầu! Người chơi 1 đi trước.</div>
        </div>
    </div>

    <div class="modal" id="card-modal">
        <div class="modal-content">
            <h2 id="modal-title">Lựa chọn hành động</h2>
            <div id="modal-body">
                <p>Bạn muốn làm gì với lá bài này?</p>
            </div>
            <div style="display:flex;justify-content:center;gap:10px;margin-top:12px;">
                <button id="modal-play-btn">Đánh / Triệu tập</button>
                <button id="modal-play-target-btn">Đánh vào đối thủ</button>
                <button id="modal-cancel-btn">Hủy</button>
            </div>
        </div>
    </div>

    <script>
        // === State ===
        const gameState = {
            currentPlayer: 1,
            players: {
                1: { timelinePoints: 20, energy: 0, maxEnergy: 0, hand: [], futureTimeline: [], manifestations: [], graveyard: [], deck: [] },
                2: { timelinePoints: 20, energy: 0, maxEnergy: 0, hand: [], futureTimeline: [], manifestations: [], graveyard: [], deck: [] }
            },
            selectedCardIndex: null, // index in current player's hand
            gameOver: false
        };

        // === Card definitions ===
        const cardDefinitions = [
            { id:1, name: "Tia Thời Gian", type: "event", cost:2, description: "Gây 3 điểm sát thương trực tiếp", effect: (player, target)=>{ target.timelinePoints -= 3; addToLog(`Tia Thời Gian gây 3 sát thương cho Người chơi ${target === gameState.players[1] ? 1 : 2}!`); } },
            { id:2, name: "Vệ binh Thời Gian", type: "manifestation", cost:3, attack:2, defense:4, description: "Khi triệu tập: đặt 1 bài từ Nghĩa trang vào Dòng thời gian", effect: (player, target)=>{ if(player.graveyard.length>0){ const c = player.graveyard.pop(); player.futureTimeline.push(c); addToLog(`Vệ binh Thời Gian đặt 1 lá từ Nghĩa trang vào Dòng thời gian!`); } } },
            { id:3, name: "Cơn Định Mệnh", type: "fate", cost:4, description: "Hủy diệt tất cả Hiện thân, mỗi lá gây 1 sát thương", effect: (player, target)=>{ const total = player.manifestations.length + target.manifestations.length; player.manifestations = []; target.manifestations = []; player.timelinePoints -= total; target.timelinePoints -= total; addToLog(`Cơn Định Mệnh hủy diệt ${total} Hiện thân và gây ${total} sát thương!`); } },
            { id:4, name: "Lời Tiên Tri", type: "fate", cost:1, description: "Rút 2 lá bài", effect: (player, target)=>{ drawCards(player,2); addToLog('Lời Tiên Tri cho phép rút thêm 2 lá bài!'); } },
            { id:5, name: "Kẻ Hủy Diệt", type: "manifestation", cost:4, attack:4, defense:2, description: "Khi bị tiêu diệt: gây 2 sát thương cho tất cả Hiện thân khác" },
            { id:6, name: "Bức Tường Thời Gian", type: "event", cost:1, description: "Giảm 2 sát thương nhận vào trong lượt này", effect: (player, target)=>{ addToLog('Bức Tường Thời Gian được kích hoạt (giảm 2 sát thương trong lượt này).'); } }
        ];

        // === Utilities ===
        function addToLog(message){
            const log = document.getElementById('game-log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = message;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function shallowCopyCard(card){ return JSON.parse(JSON.stringify(card)); }

        // === Game lifecycle ===
        function initGame(){
            // Build decks (make copies so same objects not shared)
            for(let i=1;i<=2;i++){
                gameState.players[i].deck = cardDefinitions.map(c=>shallowCopyCard(c));
                shuffle(gameState.players[i].deck);
                // draw 4 initial cards
                drawCards(gameState.players[i],5);
            }
            startTurn(1);
            renderGame();
        }

        function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }

        function drawCards(player, count){
            for(let i=0;i<count;i++){
                if(player.deck.length>0){ const c = player.deck.pop(); player.hand.push(c); }
                else { realizeFuture(player); }
            }
            renderGame();
        }

        function realizeFuture(player){
            if(player.futureTimeline.length>0){ const fate = player.futureTimeline.shift(); addToLog(`Hiện thực hóa: ${fate.name}`); const opponent = player===gameState.players[1]?gameState.players[2]:gameState.players[1]; if(typeof fate.effect==='function') fate.effect(player, opponent); player.graveyard.push(fate); }
            else { addToLog('Không còn bài để rút và không có định mệnh trong Tương lai!'); }
        }

        function startTurn(playerId){
            if(gameState.gameOver) return;
            gameState.currentPlayer = playerId;
            const p = gameState.players[playerId];
            p.maxEnergy = Math.min(10, (p.maxEnergy||0) + 1);
            p.energy = p.maxEnergy;
            addToLog(`Bắt đầu lượt Người chơi ${playerId}. Năng lượng: ${p.energy}/${p.maxEnergy}`);
            renderGame();
        }

        function endTurn(){
            if(gameState.gameOver) return;
            const next = gameState.currentPlayer===1?2:1;
            startTurn(next);
        }

        // Play card by index from current player's hand. target = 'self' | 'opponent' | null (for manifestations/fate placement)
        function playCardByIndex(cardIndex, targetChoice){
            if(gameState.gameOver) return false;
            const player = gameState.players[gameState.currentPlayer];
            const opponent = gameState.players[gameState.currentPlayer===1?2:1];
            if(cardIndex<0 || cardIndex>=player.hand.length) return false;
            const card = player.hand[cardIndex];
            if(player.energy < (card.cost||0)){ addToLog(`Không đủ năng lượng để đánh ${card.name}!`); return false; }
            player.energy -= (card.cost||0);

            if(card.type==='event'){
                addToLog(`Người chơi ${gameState.currentPlayer} kích hoạt ${card.name}.`);
                if(typeof card.effect==='function') card.effect(player, opponent);
                player.graveyard.push(card);
                player.hand.splice(cardIndex,1);
            } else if(card.type==='manifestation'){
                addToLog(`Người chơi ${gameState.currentPlayer} triệu tập ${card.name}.`);
                if(typeof card.effect==='function') card.effect(player, opponent);
                player.manifestations.push(card);
                player.hand.splice(cardIndex,1);
            } else if(card.type==='fate'){
                addToLog(`Người chơi ${gameState.currentPlayer} đặt ${card.name} vào Dòng thời gian Tương lai.`);
                player.futureTimeline.push(card);
                player.hand.splice(cardIndex,1);
            }

            checkGameOver();
            renderGame();
            return true;
        }

        // === Check Game Over ===
        function checkGameOver(){
            for(let i=1;i<=2;i++){
                if(gameState.players[i].timelinePoints <= 0){
                    gameState.gameOver = true;
                    addToLog(`Người chơi ${i} đã thua! Trò chơi kết thúc.`);
                    alert(`Người chơi ${i} đã thua!`);
                    return true;
                }
            }
            return false;
        }

        // === Rendering ===
        function renderGame(){
            // Render players
            for(let i=1;i<=2;i++){
                const p = gameState.players[i];
                document.getElementById(`player${i}-timeline`).textContent = p.timelinePoints;
                // energy dots
                const dotsContainer = document.getElementById(`player${i}-energy-dots`);
                dotsContainer.innerHTML = '';
                for(let e=0;e<p.maxEnergy;e++){ const dot = document.createElement('div'); dot.className='energy-dot'; if(e < p.energy) dot.classList.add('active'); dotsContainer.appendChild(dot); }

                // future
                const futureEl = document.getElementById(`player${i}-future`);
                futureEl.innerHTML = '';
                p.futureTimeline.forEach((c,idx)=>{ const cardEl = createCardElement(c, null, `future-${i}-${idx}`); futureEl.appendChild(cardEl); });

                // manifestations
                const maniEl = document.getElementById(`player${i}-manifestations`);
                maniEl.innerHTML = '';
                p.manifestations.forEach((c,idx)=>{ const cardEl = createCardElement(c, null, `mani-${i}-${idx}`); maniEl.appendChild(cardEl); });

                // graveyard (show names only)
                const graveEl = document.getElementById(`player${i}-graveyard`);
                graveEl.innerHTML = '';
                p.graveyard.slice(-6).forEach((c,idx)=>{ const mini = document.createElement('div'); mini.className='small'; mini.textContent = c.name; graveEl.appendChild(mini); });
            }

            // Render hand for current player
            const handEl = document.getElementById('hand-cards');
            handEl.innerHTML = '';
            const current = gameState.players[gameState.currentPlayer];
            current.hand.forEach((c, idx)=>{
                const cardEl = createCardElement(c, ()=>{ openCardModal(idx); }, `hand-${idx}`);
                handEl.appendChild(cardEl);
            });

            // Disable draw if deck and future empty
            const drawBtn = document.getElementById('draw-btn');
            const p = current;
            drawBtn.disabled = (p.deck.length===0 && p.futureTimeline.length===0);

            // If game over, disable controls
            document.getElementById('draw-btn').disabled = gameState.gameOver || drawBtn.disabled;
            document.getElementById('end-turn-btn').disabled = gameState.gameOver;
            document.getElementById('recall-btn').disabled = gameState.gameOver;
        }

        function createCardElement(card, onclick, id){
            const div = document.createElement('div'); div.className='card'; if(id) div.id = id;
            // type class
            if(card.type==='event') div.classList.add('card-event');
            else if(card.type==='manifestation') div.classList.add('card-manifestation');
            else if(card.type==='fate') div.classList.add('card-fate');

            const cost = document.createElement('div'); cost.className='card-cost'; cost.textContent = card.cost||0; div.appendChild(cost);
            const name = document.createElement('div'); name.className='card-name'; name.textContent = card.name; div.appendChild(name);
            const desc = document.createElement('div'); desc.className='card-desc'; desc.textContent = card.description || '';
            div.appendChild(desc);

            if(typeof onclick === 'function') div.addEventListener('click', onclick);
            return div;
        }

        // === Modal interactions ===
        const modal = document.getElementById('card-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalPlayBtn = document.getElementById('modal-play-btn');
        const modalPlayTargetBtn = document.getElementById('modal-play-target-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        function openCardModal(handIndex){
            const player = gameState.players[gameState.currentPlayer];
            if(handIndex<0 || handIndex>=player.hand.length) return;
            gameState.selectedCardIndex = handIndex;
            const card = player.hand[handIndex];
            modalTitle.textContent = `${card.name} — ${card.type}`;
            modalBody.innerHTML = `<p class="small">${card.description || ''}</p><p class="small">Chi phí: ${card.cost||0}</p>`;
            modal.style.display = 'flex';
        }

        modalCancelBtn.addEventListener('click', ()=>{ modal.style.display='none'; gameState.selectedCardIndex=null; });
        // Play normally (manifestation -> summon, event -> self effect, fate -> place into future)
        modalPlayBtn.addEventListener('click', ()=>{
            const idx = gameState.selectedCardIndex;
            if(idx===null) return;
            playCardByIndex(idx, 'self');
            modal.style.display='none'; gameState.selectedCardIndex=null;
        });
        // Play as targeting opponent (useful for event cards)
        modalPlayTargetBtn.addEventListener('click', ()=>{
            const idx = gameState.selectedCardIndex;
            if(idx===null) return;
            // For our simple system, playCardByIndex already targets opponent when effect needs it.
            playCardByIndex(idx, 'opponent');
            modal.style.display='none'; gameState.selectedCardIndex=null;
        });

        // Close modal when clicking outside content
        modal.addEventListener('click', (e)=>{ if(e.target===modal) { modal.style.display='none'; gameState.selectedCardIndex=null; } });

        // === Buttons ===
        document.getElementById('draw-btn').addEventListener('click', ()=>{ drawCards(gameState.players[gameState.currentPlayer],1); });
        document.getElementById('end-turn-btn').addEventListener('click', ()=>{ endTurn(); });
        document.getElementById('recall-btn').addEventListener('click', ()=>{
            // Simple recall: move last graveyard card to future timeline (if any)
            const player = gameState.players[gameState.currentPlayer];
            if(player.graveyard.length>0){ const c = player.graveyard.pop(); player.futureTimeline.push(c); addToLog(`Hồi tưởng: chuyển ${c.name} từ Nghĩa trang sang Tương lai.`); renderGame(); }
            else addToLog('Không có lá bài nào để Hồi tưởng.');
        });

        // === Initialize and expose for debugging ===
        window.addToLog = addToLog;
        window.playCardByIndex = playCardByIndex;
        window.startTurn = startTurn;

        // Start when DOM ready
        window.addEventListener('DOMContentLoaded', ()=>{ initGame(); });
    </script>
</body>
</html>