<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đấu Bài Co-op</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: white;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .screen {
            display: none;
        }
        
        .active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 16px;
        }
        
        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: #FFD700;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            font-size: 16px;
        }
        
        button:hover {
            background: #FFC400;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .code-display {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 5px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            margin: 20px 0;
            color: #FFD700;
        }
        
        .game-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .players {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .player {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            min-width: 150px;
        }
        
        .player.active {
            border: 2px solid #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        
        .player-name {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .cards {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
        }
        
        .card {
            width: 40px;
            height: 60px;
            background: white;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: black;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card.selected {
            transform: translateY(-10px);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        }
        
        .card.red {
            color: red;
        }
        
        .game-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .game-controls button {
            width: auto;
            min-width: 120px;
        }
        
        .chat-box {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            height: 150px;
            overflow-y: auto;
        }
        
        .message {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .message.system {
            color: #FFD700;
            font-style: italic;
        }
        
        .chat-input {
            display: flex;
            margin-top: 10px;
            gap: 10px;
        }
        
        .chat-input input {
            flex: 1;
        }
        
        .chat-input button {
            width: auto;
            margin: 0;
        }
        
        .status {
            text-align: center;
            margin: 10px 0;
            font-style: italic;
            color: #FFD700;
        }
        
        .connection-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .connected {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
        }
        
        .disconnected {
            background: rgba(255, 0, 0, 0.2);
            color: #ff0000;
        }
    </style>
</head>
<body>
    <div class="connection-status disconnected" id="connection-status">Mất kết nối</div>
    
    <div class="container">
        <h1>♠️♥️ ĐẤU BÀI CO-OP ♦️♣️</h1>
        
        <!-- Màn hình chính -->
        <div id="main-screen" class="screen active">
            <button id="create-room-btn">Tạo phòng mới</button>
            <div style="text-align: center; margin: 15px 0;">HOẶC</div>
            <div class="form-group">
                <label for="room-code">Nhập mã phòng:</label>
                <input type="text" id="room-code" placeholder="Nhập 6 chữ số" maxlength="6">
            </div>
            <div class="form-group">
                <label for="player-name">Tên người chơi:</label>
                <input type="text" id="player-name" placeholder="Tên của bạn" maxlength="15">
            </div>
            <button id="join-room-btn">Vào phòng</button>
        </div>
        
        <!-- Màn hình chờ -->
        <div id="waiting-screen" class="screen">
            <h2>Đang chờ người chơi...</h2>
            <div class="code-display" id="display-room-code">123456</div>
            <p>Chia sẻ mã này với bạn bè để họ tham gia phòng!</p>
            <div id="players-list"></div>
            <div class="status" id="waiting-status">Đang kết nối đến server...</div>
            <button id="start-game-btn" disabled>Bắt đầu game</button>
            <button id="exit-waiting-btn">Thoát</button>
        </div>
        
        <!-- Màn hình chơi game -->
        <div id="game-screen" class="screen">
            <h2>Phòng: <span id="game-room-code"></span></h2>
            
            <div class="game-area">
                <div class="players" id="game-players">
                    <!-- Người chơi sẽ được thêm bằng JavaScript -->
                </div>
                
                <div class="game-controls">
                    <button id="play-card-btn" disabled>Đánh bài</button>
                    <button id="draw-card-btn">Rút bài</button>
                </div>
                
                <div class="chat-box" id="chat-messages">
                    <div class="message system">Chào mừng đến với game đấu bài!</div>
                </div>
                
                <div class="chat-input">
                    <input type="text" id="chat-input" placeholder="Nhắn tin...">
                    <button id="send-message-btn">Gửi</button>
                </div>
                
                <button id="exit-game-btn">Thoát game</button>
            </div>
        </div>
    </div>

    <script>
        // Các phần tử DOM
        const mainScreen = document.getElementById('main-screen');
        const waitingScreen = document.getElementById('waiting-screen');
        const gameScreen = document.getElementById('game-screen');
        const connectionStatus = document.getElementById('connection-status');
        
        const roomCodeInput = document.getElementById('room-code');
        const playerNameInput = document.getElementById('player-name');
        const displayRoomCode = document.getElementById('display-room-code');
        const playersList = document.getElementById('players-list');
        const gameRoomCode = document.getElementById('game-room-code');
        const gamePlayers = document.getElementById('game-players');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const waitingStatus = document.getElementById('waiting-status');
        
        // Nút bấm
        const createRoomBtn = document.getElementById('create-room-btn');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const startGameBtn = document.getElementById('start-game-btn');
        const exitWaitingBtn = document.getElementById('exit-waiting-btn');
        const playCardBtn = document.getElementById('play-card-btn');
        const drawCardBtn = document.getElementById('draw-card-btn');
        const sendMessageBtn = document.getElementById('send-message-btn');
        const exitGameBtn = document.getElementById('exit-game-btn');
        
        // Biến toàn cục
        let socket = null;
        let currentRoomCode = '';
        let currentPlayer = '';
        let currentPlayerId = '';
        let players = [];
        let cards = [];
        let selectedCardIndex = -1;
        let isHost = false;
        
        // Kết nối WebSocket (thay đổi URL này thành địa chỉ server thực tế của bạn)
        const WS_URL = "wss://socketsbay.com/wss/v2/1/demo/";
        
        function connectWebSocket() {
            try {
                socket = new WebSocket(WS_URL);
                
                socket.onopen = () => {
                    console.log('Kết nối WebSocket thành công');
                    connectionStatus.textContent = 'Đã kết nối';
                    connectionStatus.className = 'connection-status connected';
                };
                
                socket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };
                
                socket.onclose = () => {
                    console.log('Kết nối WebSocket đã đóng');
                    connectionStatus.textContent = 'Mất kết nối';
                    connectionStatus.className = 'connection-status disconnected';
                    
                    // Thử kết nối lại sau 3 giây
                    setTimeout(connectWebSocket, 3000);
                };
                
                socket.onerror = (error) => {
                    console.error('Lỗi WebSocket:', error);
                    connectionStatus.textContent = 'Lỗi kết nối';
                    connectionStatus.className = 'connection-status disconnected';
                };
            } catch (error) {
                console.error('Lỗi khi kết nối WebSocket:', error);
            }
        }
        
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'room_created':
                    handleRoomCreated(data);
                    break;
                case 'player_joined':
                    handlePlayerJoined(data);
                    break;
                case 'player_left':
                    handlePlayerLeft(data);
                    break;
                case 'game_started':
                    handleGameStarted(data);
                    break;
                case 'card_played':
                    handleCardPlayed(data);
                    break;
                case 'card_drawn':
                    handleCardDrawn(data);
                    break;
                case 'chat_message':
                    handleChatMessage(data);
                    break;
                case 'error':
                    handleError(data);
                    break;
            }
        }
        
        function handleRoomCreated(data) {
            currentRoomCode = data.roomCode;
            currentPlayerId = data.playerId;
            isHost = true;
            
            displayRoomCode.textContent = currentRoomCode;
            players = data.players;
            updatePlayersList();
            
            waitingStatus.textContent = 'Phòng đã được tạo. Đang chờ người chơi khác...';
            startGameBtn.disabled = players.length < 2;
            
            showScreen(waitingScreen);
            addChatMessage('Hệ thống', `Phòng ${currentRoomCode} đã được tạo.`, true);
        }
        
        function handlePlayerJoined(data) {
            players = data.players;
            updatePlayersList();
            
            if (isHost) {
                startGameBtn.disabled = players.length < 2;
            }
            
            addChatMessage('Hệ thống', `${data.playerName} đã tham gia phòng.`, true);
        }
        
        function handlePlayerLeft(data) {
            players = data.players;
            updatePlayersList();
            
            if (isHost) {
                startGameBtn.disabled = players.length < 2;
            }
            
            addChatMessage('Hệ thống', `${data.playerName} đã rời phòng.`, true);
        }
        
        function handleGameStarted(data) {
            gameRoomCode.textContent = currentRoomCode;
            cards = data.cards;
            initializeGame();
            showScreen(gameScreen);
            addChatMessage('Hệ thống', 'Game đã bắt đầu!', true);
        }
        
        function handleCardPlayed(data) {
            if (data.playerId === currentPlayerId) return;
            
            addChatMessage(data.playerName, `đã đánh lá bài ${data.card.value}${data.card.suit}`);
            updateOtherPlayerCards(data.playerId, data.cardsCount);
        }
        
        function handleCardDrawn(data) {
            if (data.playerId === currentPlayerId) return;
            
            addChatMessage(data.playerName, `đã rút một lá bài`);
            updateOtherPlayerCards(data.playerId, data.cardsCount);
        }
        
        function handleChatMessage(data) {
            if (data.playerId === currentPlayerId) return;
            addChatMessage(data.playerName, data.message);
        }
        
        function handleError(data) {
            alert(`Lỗi: ${data.message}`);
            if (data.fatal) {
                showScreen(mainScreen);
            }
        }
        
        function sendWebSocketMessage(message) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify(message));
            } else {
                alert('Mất kết nối đến server. Vui lòng thử lại.');
            }
        }
        
        // Tạo phòng mới
        createRoomBtn.addEventListener('click', () => {
            const playerName = playerNameInput.value.trim();
            if (!playerName) {
                alert('Vui lòng nhập tên người chơi!');
                return;
            }
            
            currentPlayer = playerName;
            
            // Gửi yêu cầu tạo phòng
            sendWebSocketMessage({
                type: 'create_room',
                playerName: playerName
            });
        });
        
        // Tham gia phòng
        joinRoomBtn.addEventListener('click', () => {
            const code = roomCodeInput.value.trim();
            const playerName = playerNameInput.value.trim();
            
            if (!code || code.length !== 6) {
                alert('Mã phòng phải có 6 chữ số!');
                return;
            }
            
            if (!playerName) {
                alert('Vui lòng nhập tên người chơi!');
                return;
            }
            
            currentRoomCode = code;
            currentPlayer = playerName;
            
            // Gửi yêu cầu tham gia phòng
            sendWebSocketMessage({
                type: 'join_room',
                roomCode: code,
                playerName: playerName
            });
            
            waitingStatus.textContent = 'Đang kết nối đến phòng...';
            showScreen(waitingScreen);
        });
        
        // Bắt đầu game
        startGameBtn.addEventListener('click', () => {
            sendWebSocketMessage({
                type: 'start_game',
                roomCode: currentRoomCode
            });
        });
        
        // Thoát phòng chờ
        exitWaitingBtn.addEventListener('click', () => {
            sendWebSocketMessage({
                type: 'leave_room',
                roomCode: currentRoomCode,
                playerId: currentPlayerId
            });
            showScreen(mainScreen);
        });
        
        // Thoát game
        exitGameBtn.addEventListener('click', () => {
            sendWebSocketMessage({
                type: 'leave_room',
                roomCode: currentRoomCode,
                playerId: currentPlayerId
            });
            showScreen(mainScreen);
        });
        
        // Đánh bài
        playCardBtn.addEventListener('click', () => {
            if (selectedCardIndex === -1) {
                alert('Vui lòng chọn lá bài để đánh!');
                return;
            }
            
            const playedCard = cards[selectedCardIndex];
            cards.splice(selectedCardIndex, 1);
            selectedCardIndex = -1;
            updatePlayerCards();
            
            sendWebSocketMessage({
                type: 'play_card',
                roomCode: currentRoomCode,
                playerId: currentPlayerId,
                card: playedCard
            });
            
            addChatMessage(currentPlayer, `đã đánh lá bài ${playedCard.value}${playedCard.suit}`);
            playCardBtn.disabled = true;
        });
        
        // Rút bài
        drawCardBtn.addEventListener('click', () => {
            const newCard = drawRandomCard();
            cards.push(newCard);
            updatePlayerCards();
            
            sendWebSocketMessage({
                type: 'draw_card',
                roomCode: currentRoomCode,
                playerId: currentPlayerId
            });
            
            addChatMessage(currentPlayer, `đã rút một lá bài`);
        });
        
        // Gửi tin nhắn
        sendMessageBtn.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });
        
        // Hàm utility
        function showScreen(screen) {
            mainScreen.classList.remove('active');
            waitingScreen.classList.remove('active');
            gameScreen.classList.remove('active');
            screen.classList.add('active');
        }
        
        function updatePlayersList() {
            playersList.innerHTML = '';
            players.forEach(player => {
                const playerEl = document.createElement('div');
                playerEl.cl